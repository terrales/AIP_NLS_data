<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Details</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 20px;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }
        .back-button:hover {
            background: #0056b3;
        }
        #chart {
            width: 100%;
            height: 600px;
        }
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .legend-line {
            display: inline-block;
            width: 30px;
            height: 3px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .legend-line.bold {
            height: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
    <a class="back-button" href="./language_bubbles.html">‚Üê Back to Overview</a>
        <h1 id="language-name">Language Popularity Over Time</h1>
        <p class="subtitle">Showing publication frequency across all time periods</p>
        <div id="chart"></div>
        <div class="legend" id="legend"></div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        // Get the selected language from URL
        const urlParams = new URLSearchParams(window.location.search);
        const selectedLanguage = urlParams.get('language');

        // Update page title
        if (selectedLanguage) {
            document.getElementById('language-name').textContent = `${selectedLanguage} - Popularity Over Time`;
        }

        // Load the CSV data
        Papa.parse('./data_cleaned.csv', {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                
                // Process the data to create time series
                const timeSeriesData = processTimeSeriesData(data);
                
                if (timeSeriesData.series.length === 0) {
                    document.getElementById('chart').innerHTML = 
                        '<p style="color: orange; padding: 20px;">No time-series data available. Check date format in CSV.</p>';
                    return;
                }
                
                createLineChart(timeSeriesData, selectedLanguage);
            },
            error: function(error) {
                console.error('Error loading CSV:', error);
                document.getElementById('chart').innerHTML = 
                    '<p style="color: red; padding: 20px;">Error loading data_cleaned.csv. Please check the file path.</p>';
            }
        });

        function processTimeSeriesData(data) {
            // Extract year from date column and count by language and year
            const yearLanguageCounts = {};
            const years = new Set();
            
            data.forEach(row => {
                if (!row.date || !row.language) return;
                
                // Try to extract year from date (handles various formats)
                let year;
                const dateStr = String(row.date).trim();
                
                // Try different date formats
                if (/^\d{4}$/.test(dateStr)) {
                    // Just a year: "2020"
                    year = parseInt(dateStr);
                } else if (/^\d{4}-/.test(dateStr)) {
                    // ISO format: "2020-01-15"
                    year = parseInt(dateStr.substring(0, 4));
                } else if (/\/\d{4}$/.test(dateStr)) {
                    // Format: "01/15/2020" or "15/01/2020"
                    const parts = dateStr.split('/');
                    year = parseInt(parts[parts.length - 1]);
                } else {
                    // Try to extract any 4-digit number
                    const match = dateStr.match(/\b(1\d{3}|20\d{2})\b/);
                    if (match) {
                        year = parseInt(match[1]);
                    }
                }
                
                if (!year || year < 1500 || year > 2030) return; // Filter invalid years
                
                years.add(year);
                const language = row.language.trim();
                
                if (!yearLanguageCounts[language]) {
                    yearLanguageCounts[language] = {};
                }
                
                if (!yearLanguageCounts[language][year]) {
                    yearLanguageCounts[language][year] = 0;
                }
                
                yearLanguageCounts[language][year]++;
            });
            
            const sortedYears = Array.from(years).sort((a, b) => a - b);
            
            // Convert to series format
            const series = Object.keys(yearLanguageCounts).map(language => {
                return {
                    language: language,
                    values: sortedYears.map(year => ({
                        year: year,
                        count: yearLanguageCounts[language][year] || 0
                    }))
                };
            });
            
            return { series: series, years: sortedYears };
        }

        function createLineChart(data, selectedLanguage) {
            const margin = {top: 20, right: 120, bottom: 50, left: 60};
            const width = document.getElementById('chart').offsetWidth - margin.left - margin.right;
            const height = 600 - margin.top - margin.bottom;

            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Scales
            const x = d3.scaleLinear()
                .domain(d3.extent(data.years))
                .range([0, width]);

            const maxCount = d3.max(data.series, d => d3.max(d.values, v => v.count));
            const y = d3.scaleLinear()
                .domain([0, maxCount])
                .range([height, 0]);

            // Color scale
            const colorScale = d3.scaleOrdinal(d3.schemeCategory10);

            // Axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickFormat(d3.format("d")))
                .append("text")
                .attr("x", width / 2)
                .attr("y", 40)
                .attr("fill", "black")
                .style("font-size", "14px")
                .text("Year");

            svg.append("g")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -50)
                .attr("x", -height / 2)
                .attr("fill", "black")
                .style("font-size", "14px")
                .text("Publication Count");

            // Line generator
            const line = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.count));

            // Sort series so selected language is drawn last (on top)
            const sortedSeries = data.series.sort((a, b) => {
                if (a.language === selectedLanguage) return 1;
                if (b.language === selectedLanguage) return -1;
                return 0;
            });

            // Draw lines
            sortedSeries.forEach((languageData, i) => {
                const isSelected = languageData.language === selectedLanguage;
                
                svg.append("path")
                    .datum(languageData.values)
                    .attr("fill", "none")
                    .attr("stroke", isSelected ? "#e74c3c" : colorScale(i))
                    .attr("stroke-width", isSelected ? 4 : 1.5)
                    .attr("stroke-opacity", isSelected ? 1 : 0.3)
                    .attr("d", line)
                    .style("pointer-events", "none");
            });

            // Add legend for top languages + selected
            const topLanguages = data.series
                .sort((a, b) => d3.sum(b.values, v => v.count) - d3.sum(a.values, v => v.count))
                .slice(0, 10);
            
            // Ensure selected language is in legend
            if (selectedLanguage && !topLanguages.find(d => d.language === selectedLanguage)) {
                const selectedData = data.series.find(d => d.language === selectedLanguage);
                if (selectedData) {
                    topLanguages.push(selectedData);
                }
            }

            const legend = d3.select("#legend");
            topLanguages.forEach((languageData, i) => {
                const isSelected = languageData.language === selectedLanguage;
                const color = isSelected ? "#e74c3c" : colorScale(data.series.indexOf(languageData));
                
                const item = legend.append("div")
                    .attr("class", "legend-item");
                
                item.append("span")
                    .attr("class", isSelected ? "legend-line bold" : "legend-line")
                    .style("background-color", color)
                    .style("opacity", isSelected ? 1 : 0.6);
                
                item.append("span")
                    .style("font-weight", isSelected ? "bold" : "normal")
                    .style("color", isSelected ? "#e74c3c" : "#333")
                    .text(languageData.language);
            });
        }
    </script>
</body>
</html>